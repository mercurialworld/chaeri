{"version":3,"file":"index.js","sources":["../../../../deploy-codedeploy/index.ts"],"sourcesContent":["import * as core from \"@actions/core\";\nimport * as exec from \"@actions/exec\";\nimport * as github from \"@actions/github\";\nimport {\n    BundleType,\n    CodeDeployClient,\n    CreateDeploymentCommand,\n    CreateDeploymentCommandInput,\n} from \"@aws-sdk/client-codedeploy\";\n\nasync function run() {\n    try {\n        const path = core.getInput(\"path\", { required: true });\n        const stack = core.getInput(\"stack\", { required: true });\n        const application = core.getInput(\"application\", { required: true });\n        const deploymentGroup = core.getInput(\"deployment-group\", {\n            required: true,\n        });\n        const s3Bucket = \"chaeri-codedeploy-artifacts\";\n\n        const s3Key = `${stack}/${github.context.sha}.zip`;\n        const codedeployClient = new CodeDeployClient();\n\n        // Upload deployment bundle to S3\n        core.info(\"Uploading deployment bundle to S3...\");\n        await exec.exec(\"aws\", [\n            \"deploy\",\n            \"push\",\n            `--application-name=${application}`,\n            `--s3-location=s3://${s3Bucket}/${s3Key}`,\n            `--source=${path}`,\n        ]);\n\n        // Create CodeDeploy deployment\n        const deploymentParams: CreateDeploymentCommandInput = {\n            applicationName: application,\n            deploymentGroupName: deploymentGroup,\n            revision: {\n                s3Location: {\n                    bucket: s3Bucket,\n                    key: s3Key,\n                    bundleType: BundleType.Zip,\n                },\n            },\n        };\n\n        core.info(\"Creating CodeDeploy deployment...\");\n        const command = new CreateDeploymentCommand(deploymentParams);\n\n        const { deploymentId } = await codedeployClient.send(command);\n        const deploymentURL = `https://${process.env.AWS_REGION}.console.aws.amazon.com/codesuite/codedeploy/deployments/${deploymentId}?region=${process.env.AWS_REGION}`;\n\n        core.info(`Deployment URL: ${deploymentURL}`);\n\n        core.setOutput(\"s3-key\", s3Key);\n        core.setOutput(\"deployment-id\", deploymentId);\n        core.setOutput(\"deployment-url\", deploymentURL);\n\n        // Wait for deployment to finish\n        core.info(\"Waiting for deployment to finish...\");\n        await exec.exec(\"aws\", [\n            \"deploy\",\n            \"wait\",\n            \"deployment-successful\",\n            `--deployment-id=${deploymentId}`,\n        ]);\n\n        core.info(\"this probably successfully deployed\");\n    } catch (error: any) {\n        core.setFailed(error.message);\n    }\n}\n\nrun();\n"],"names":[],"mappings":"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"}